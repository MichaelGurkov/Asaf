
```{r, echo=FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

```


```{r load_libraries}

library(tidyverse)

library(forecast)

library(tsibble)

library(lubridate)

library(forcats)

library(slider)

library(tidymodels)


```


```{r Import_data}

spy = read_csv(paste0(file.path(Sys.getenv("USERPROFILE"),
                                fsep = "\\"),                      "\\OneDrive - Bank Of Israel\\Data\\Asaf\\SPX.csv"))

spy = spy %>%
  rename_all(~tolower(.)) %>%
  mutate(date = mdy(date)) %>%
  as_tsibble(index = "date") %>%
  mutate_if(~is.character(.), ~as.numeric(.))

```

# Intro

The purpose is to identify the factors that affect (10) day return of SPX.

## Let's take a look at Earnings per Share


# Preprocessing


```{r Preprocessing}

# Calculate time periods

work_df = spy %>%
  mutate(ret_10 = slide_dbl(spx_index,~diff(log(.x[c(1,10)])),
                            .before = 9,
                              .complete = TRUE)) %>%
  mutate(ret_15 = slide_dbl(spx_index,~diff(log(.x[c(1,15)])),
                            .before = 14,
                             .complete = TRUE)) %>%
  mutate(ret_30 = slide_dbl(spx_index,~diff(log(.x[c(1,30)])),
                            .before = 29,
                              .complete = TRUE))

# Convert ret 10 to binary

work_df = work_df %>% 
  mutate(ret_10_below_5 = as.numeric(ret_10 < -0.05))


# Bin returns distribution

work_df = work_df %>% 
  mutate(ret_10_cat = cut(
    ret_10,
    breaks = c(-Inf,-0.1,-0.05,0,0.05,0.1,Inf),
    labels = c("10-","-10_-5","-5_0","0-5","5-10","10+"),
    ordered_result = TRUE))


#EPS

work_df = work_df %>% 
  mutate(eps_diff = c(NA,diff(t12_eps_aggte)))



```

# Plotting


```{r plot_ret_10_dist}

ggplot(work_df, aes(x = date, y = ret_10)) + 
  geom_line() + 
  labs(x = "", y = "", title = "Returns (10 day period)") + 
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 0.01)) + 
  geom_hline(yintercept = -0.05, color = "blue",
             linetype = "dashed") + 
  geom_point(data = work_df %>% 
               filter(ret_10 < -0.05),
             aes(x = date, y = -0.05), color = "red") + 
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5))

ggplot(work_df, aes(x = ret_10)) + 
  geom_density() + 
  labs(x = "", y = "", title = "Returns (10 day period)") + 
  scale_x_continuous(labels = scales::percent_format(accuracy = 0.01)) +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5))



```


```{r plot_categorical_ret_dist}

ret_cat_dist = table(work_df$ret_10_cat) %>% 
         as.data.frame()

ggplot(ret_cat_dist, aes(x = Var1, y = Freq)) + 
  geom_col() + 
  geom_text(aes(x = Var1, y = Freq,
                label = scales::percent(Freq / sum(Freq),accuracy = 0.1)),
            color = "magenta", vjust = -1) + 
  labs(x = "Return bins", y = "", title = "Frequency of return bins") + 
  scale_y_continuous(labels = scales::comma_format(),
                     limits = c(0,max(ret_cat_dist$Freq) * 1.05)) +
  theme_bw() + 
  theme(plot.title = element_text(hjust = 0.5))

rm(ret_cat_dist)
```


## Returns vs EPS

```{r plot_returns_vs_eps}

ggplot(work_df %>% 
         filter(eps_diff > 0), aes(x = log(eps_diff), y = ret_10)) + 
  labs(x = "log change EPS", y = "", title = "10 day return vs changes in EPS") + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.1)) + 
  geom_point() + 
  geom_smooth(method = "loess") +
  theme_bw()

```



```{r plot_cat_returns_vs_eps}

ggplot(work_df %>% 
         select(ret_10_cat, t12_eps_aggte) %>% 
         filter(complete.cases(.)), aes(x = t12_eps_aggte, y = ret_10_cat)) + 
  labs(x = "EPS", y = "", title = "10 day return (binned) vs EPS") + 
  geom_point() + 
  theme_bw()

```


Seems there is no relationship between EPS and (10) day return.

# Model fitting


```{r fit model}

model_fit_list = list()

log_model = logistic_reg() %>% 
  set_engine("glm") %>% 
  set_mode("classification")

model_fit_list$log_fit = log_model %>% 
  fit(as_factor(ret_10_below_5) ~ .,
      data = work_df %>% 
        select(-starts_with("ret"),ret_10_below_5))



```


```{r cross_walidation, eval=FALSE}

roll_grid = rolling_origin(data = work_df %>% 
                             select(-starts_with("ret"),ret_10_below_5),
                           initial = 365,
                           assess = 10)

get_score = function(temp_split){
  
    test_set = assessment(temp_split)
    
    pred_df = predict(model_fit_list$log_fit,
                    new_data = test_set,type = "class")
    
    pred_df = pred_df %>% 
      cbind(test_set$ret_10_below_5) %>% 
      set_names(c("trigger", "truth")) %>% 
      mutate_all(~factor(., levels = c("1","0")))
    
    score = accuracy(data = pred_df,truth = truth,trigger)
    
    
    return(score$.estimate)
  
}

scores = map_data(roll_grid$splits, get_score)




```


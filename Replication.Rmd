---
title: Exploratory Data Analysis
---


```{r, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

```


```{r setup}

devtools::load_all()

library(tidyverse)

library(lubridate)

theme_set(theme_bw() +
            theme(legend.position = "bottom",
                  legend.title = element_blank()))

```


```{r import_data}

data("sp_data")

```

# Replication

```{r plot_pe}

df %>% 
  filter(date >= as.Date("2000-01-01")) %>% 
  ggplot(aes(x = date, y = indx_general_pe_ratio)) + 
  geom_line() + 
  xlab(NULL) + ylab(NULL) + ggtitle("PE multiple - S&P 500")

```


```{r plot_sp_spread}

df %>% 
  ggplot(aes(x = date, y = sp_spread)) + 
  geom_line() + 
  xlab(NULL) + ylab(NULL) + ggtitle("SP spread")

```


```{r plot_sp_spread_vs_other_spreads}

df %>% 
  select(date, sp_spread, inv_grade_spread, high_yield_spread) %>% 
  filter(date >= as.Date("2000-01-01")) %>% 
  pivot_longer(-date) %>% 
  ggplot(aes(x = date, y = value, color = name)) + 
  geom_line() + 
  xlab(NULL) + ylab(NULL) + ggtitle("Spreads comparison")

```





# Prediction

```{r plot_sp_spread_comparison}

df %>% 
  select(date, spx_index, sp_spread) %>% 
  pivot_longer(-date) %>% 
  filter(date >= as.Date("2000-01-01")) %>% 
  filter(complete.cases(.)) %>% 
  group_by(name) %>% 
  mutate(value = value / abs(max(value))) %>% 
  ggplot(aes(x = date, y = value, color = name)) + 
  geom_line() + 
  xlab(NULL) + ylab(NULL) + 
  ggtitle(paste0("Comparison between S&P index and spread",
                 "\n (normalized by max value to get (-1,1) range)"))

```


There seem to be no visible relationship between the index and the spread


```{r plot_sp_}

df %>% 
  filter(date >= as.Date("2000-01-01")) %>% 
  ggplot(aes(x = date, y = sp_spread)) +
  geom_line() + 
  # geom_smooth(method = "loess") + 
  geom_vline(data = df %>% 
               select(date, sp_ret) %>% 
               filter(!is.na(sp_ret)) %>% 
               filter(cumprod(1 + sp_ret) < 0),
             aes(xintercept = date),
             color = "red", size = 3) + 
  xlab(NULL) + ylab(NULL) + 
  ggtitle("")

```


